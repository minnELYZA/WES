<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
	<title>SOC</title>
        <style>
		@import url(css/bootstrap.min.css);
		@import url(css/style.css);
		@import url(css/colorbrewer.css);
		@import url(css/d3.parsets.css);
            rect.bordered {
                stroke: #E6E6E6;
                stroke-width:2px;   
            }

            text.mono {
                font-size: 9pt;
                font-family: Consolas, courier;
                fill: #aaa;
            }

            text.axis-workweek {
                fill: #000;
            }

            text.axis-worktime {
                fill: #000;
            }
        </style>
        <script src="http://d3js.org/d3.v3.js"></script>
        <script src="https://dl.dropboxusercontent.com/u/90319558/d3.parsets.js" type="text/javascript"></script>
        <link href="https://dl.dropboxusercontent.com/u/90319558/d3.parsets.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
		<header>
			<h1>SPECIALIST OUTPATIENT CLINIC</h1>
		</header>
        <h2>View: 
            <select id="view">
                <option value="All" selected="selected">All appointments</option>
                <option value="Hand">Hand</option>
                <option value="Foot">Foot</option>
                <option value="Trauma">Trauma</option>
                <option value="Sports">Sports</option>
            </select>
        </h2>
        <div id="chart"></div>

        <script type="text/javascript">
            var margin = {top: 20, right: 0, bottom: 100, left: 30},
            width = 960 - margin.left - margin.right,
                    height = 480 - margin.top - margin.bottom,
                    gridSize = Math.floor(width / 32),
                    legendElementWidth = gridSize * 2,
                    colors = ["#FFFAFA", "#FFE4E1", "#F8AEAE", "#DC143C", "#8B0000"],
                    //days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                    day = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31"],
                    month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            //d3.tsv("https://dl.dropboxusercontent.com/u/90319558/Heatmap_All.txt",
			d3.tsv("data/Heatmap_All.txt",
                    function (d) {
                        return {
                            day: +d.Day,
                            month: +d.Month,
                            appt: +d.Appointment
                        };
                    },
                    function (error, data) {
                        // color scale for heatmap
                        var colorScale = d3.scale.quantile()
                                .domain([0, d3.max(data, function (d) {
                                        return d.appt;
                                    })])
                                .range(colors);

                        // chart and svg
                        var svg = d3.select("#chart").append("svg")
                                .attr("width", width + margin.left + margin.right)
                                .attr("height", height + margin.top + margin.bottom)
                                .append("g")
                                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                                .attr("id", "heatmap");

                        // y axis
                        var monthLabels = svg.selectAll(".monthLabel")
                                .data(month)
                                .enter().append("text")
                                .text(function (d) {
                                    return d;
                                })
                                .attr("x", 0)
                                .attr("y", function (d, i) {
                                    return i * gridSize;
                                })
                                .style("text-anchor", "end")
                                .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
                                .attr("class", "monthLabel mono axis axis-workweek");

                        // x axis
                        var dayLabels = svg.selectAll(".dayLabel")
                                .data(day)
                                .enter().append("text")
                                .text(function (d) {
                                    return d;
                                })
                                .attr("x", function (d, i) {
                                    return i * gridSize;
                                })
                                .attr("y", 0)
                                .style("text-anchor", "middle")
                                .attr("transform", "translate(" + gridSize / 2 + ", -6)")
                                .attr("class", "dayLabel mono axis axis-worktime");

                        // heatmap
                        var heatMap = svg.selectAll(".dailyBlock")
                                .data(data)
                                .enter().append("rect")
                                .attr("x", function (d) {
                                    return (d.day - 1) * gridSize;
                                })
                                .attr("y", function (d) {
                                    return (d.month - 1) * gridSize;
                                })
                                .attr("rx", 4)
                                .attr("ry", 4)
                                .attr("class", "dailyBlock bordered")
                                .attr("width", gridSize)
                                .attr("height", gridSize)
                                .attr("id", "dayBlock")
                                .attr("value", function (d) {
                                    return d.month + "," + d.day;
                                })
                                .style("fill", colors[0]);

                        // heatmap transition duration
                        heatMap.transition().duration(1000)
                                .style("fill", function (d) {
                                    return colorScale(d.appt);
                                });

                        // text for heatmap tooltip
                        heatMap.append("title").text(function (d) {
                            return d.appt + " appointments";
                        });

                        // color scale for legend
                        var legend = svg.selectAll(".legend")
                                .data([0].concat(colorScale.quantiles()), function (d) {
                                    return d;
                                })
                                .enter().append("g")
                                .attr("transform", "translate(" + gridSize / 2 + ", 15)")
                                .attr("class", "legend");

                        // rect for legend
                        legend.append("rect")
                                .attr("x", function (d, i) {
                                    return legendElementWidth * i;
                                })
                                .attr("y", height)
                                .attr("width", legendElementWidth)
                                .attr("height", gridSize / 2)
                                .style("fill", function (d, i) {
                                    return colors[i];
                                });

                        // text for the legend
                        legend.append("text")
                                .attr("class", "mono")
                                .text(function (d) {
                                    return ">= " + Math.round(d);
                                })
                                .attr("x", function (d, i) {
                                    return legendElementWidth * i;
                                })
                                .attr("y", height + gridSize);

                        var totalAppt = 0;
                        for (var i = 0; i < data.length; i++) {
                            var item = data[i];
                            totalAppt = totalAppt + item.appt;
                        }

                        // parallel sets
                        var chart = d3.parsets()
                                .dimensions(["Attendance", "Source of Referral", "Patient Class", "First Visit"]);

                        var vis = d3.select("#chart").append("svg")
                                .attr("width", "930")
                                .attr("height", chart.height())
                                .attr("id", "parallelsets");

                        //d3.csv("https://dl.dropboxusercontent.com/u/90319558/ParallelSets.csv", function (error, csv) {
						d3.csv("data/ParallelSets.csv", function (error, csv) {
                            vis.datum(csv).call(chart);
                        });
                        // end of parallel sets

                        // set on change event for dropdownlist
                        d3.select("#view").on("change", function (d) {
                            updateView(this.value);
                            updateParallelSetsInfo(this.value);
                        });

                        // set on click event for heatmap
                        d3.selectAll("#dayBlock").on("click", function (d) {
                            var view = document.getElementById("view");
                            var viewOption = view.options[view.selectedIndex].value;
                            updateParallelSetsInfo(this.getAttribute("value") + "," + viewOption);
                        });

                        // function to update parallel sets
                        function updateParallelSetsInfo(value) {
                            var vis = d3.select("#parallelsets");
                            vis.remove();
                            
                            vis = d3.select("#chart").append("svg")
                                .attr("width", "930")
                                .attr("height", chart.height())
                                .attr("id", "parallelsets");

                            //d3.csv("https://dl.dropboxusercontent.com/u/90319558/ParallelSets.csv", function (error, csv) {
							d3.csv("data/ParallelSets.csv", function (error, csv) {
                                vis.datum(csv.filter(function (d) {
                                    if (value.indexOf(",") > -1) {
                                        var valueStr = value.split(',')
                                        if (valueStr[2] === "All") {
                                            return d.Day === valueStr[1] && d.Month === valueStr[0];
                                        } else {
                                            return d.Day === valueStr[1] && d.Month === valueStr[0] && d.Subspecialty === valueStr[2];
                                        }
                                    } else {
                                        return d.Subspecialty === value;
                                    }
                                })).call(chart);
                            });
                        }

                        // function to update heatmap
                        function updateView(value) {
                            var fileName = "Heatmap_All.txt";
                            if (value == "Hand") {
                                fileName = "Heatmap_Hand.txt";
                            } else if (value == "Foot") {
                                fileName = "Heatmap_Foot.txt";
                            } else if (value == "Trauma") {
                                fileName = "Heatmap_Trauma.txt";
                            } else if (value == "Sports") {
                                fileName = "Heatmap_Sports.txt";
                            }
                            //d3.tsv("https://dl.dropboxusercontent.com/u/90319558/" + fileName, function (d) {
							d3.tsv("data/" + fileName, function (d) {
                                return {
                                    day: +d.Day,
                                    month: +d.Month,
                                    appt: +d.Appointment,
                                };
                            },
                                    function (error, data) {
                                        var colorScale = d3.scale.quantile()
                                                .domain([0, d3.max(data, function (d) {
                                                        return d.appt;
                                                    })])
                                                .range(colors);

                                        var heatMap = svg.selectAll(".dailyBlock");
                                        heatMap.remove();

                                        heatMap = svg.selectAll(".dailyBlock")
                                                .data(data)
                                                .enter().append("rect")
                                                .attr("x", function (d) {
                                                    return (d.day - 1) * gridSize;
                                                })
                                                .attr("y", function (d) {
                                                    return (d.month - 1) * gridSize;
                                                })
                                                .attr("rx", 4)
                                                .attr("ry", 4)
                                                .attr("class", "dailyBlock bordered")
                                                .attr("width", gridSize)
                                                .attr("height", gridSize)
                                                .attr("id", "dayBlock")
                                                .attr("value", function (d) {
                                                    return d.month + "," + d.day;
                                                })
                                                .style("fill", colors[0]);

                                        // fill heat map tile color
                                        heatMap.transition().duration(1000)
                                                .style("fill", function (d) {
                                                    return colorScale(d.appt);
                                                });

                                        // tooltip text
                                        heatMap.selectAll("title").remove();
                                        heatMap.append("title").text(function (d) {
                                            return d.appt + " appointments";
                                        });

                                        // color legend
                                        var legend = svg.selectAll(".legend");
                                        legend.remove();
                                        var legend = svg.selectAll(".legend")
                                                .data([0].concat(colorScale.quantiles()), function (d) {
                                                    return d;
                                                })
                                                .enter().append("g")
                                                .attr("transform", "translate(" + gridSize / 2 + ", 30)")
                                                .attr("class", "legend");

                                        // rect for legend
                                        legend.append("rect")
                                                .attr("x", function (d, i) {
                                                    return legendElementWidth * i;
                                                })
                                                .attr("y", height)
                                                .attr("width", legendElementWidth)
                                                .attr("height", gridSize / 2)
                                                .style("fill", function (d, i) {
                                                    return colors[i];
                                                });

                                        // text for the legend
                                        legend.selectAll("text").remove();
                                        legend.append("text")
                                                .attr("class", "mono")
                                                .text(function (d) {
                                                    return ">= " + Math.round(d);
                                                })
                                                .attr("x", function (d, i) {
                                                    return legendElementWidth * i;
                                                })
                                                .attr("y", height + gridSize);

                                        d3.selectAll("#dayBlock").on("click", function (d) {
                                            var view = document.getElementById("view");
                                            var viewOption = view.options[view.selectedIndex].value;
                                            updateParallelSetsInfo(this.getAttribute("value") + "," + viewOption);
                                        });
                                    });
                        }
                    });


        </script>
    </body>
</html>